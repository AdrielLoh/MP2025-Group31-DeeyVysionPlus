<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Try Physiological Signal Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let form = document.getElementById("upload-form");
            let spinner = document.getElementById("loadingSpinner");

            form.addEventListener("submit", function(event) {
                event.preventDefault();

                // Disable the button and change text
                submitButton.disabled = true;
                submitButton.innerText = "Processing...";

                // Show the spinner
                spinner.style.display = "block";

                // Submit the form normally
                form.setAttribute("action", "/physiological_signal_try");
                form.setAttribute("method", "POST");
                form.submit();
                return;
            });
        });
    </script>
</head>
<body>
    <header>
        <div id="navbar-placeholder"></div>
    </header>
    <section class="content">
        <h1>Try Physiological Signal Detection</h1>
        <form id="upload-form" enctype="multipart/form-data">
            <div id="dropbox" class="dropbox">
                <p>Drag & drop a video file here, or click to select one</p>
                <input type="file" name="file" id="file" accept="video/*" required>
                <video id="video-preview" controls style="display: none;"></video>
            </div>
            <button type="submit" id="submitButton">Submit</button>
            <div id="loadingSpinner">
                <div class="spinner"></div>
                <p>Processing video... Please wait.</p>
            </div>
        </form>
        <h3>Real-Time Detection (Webcam)</h3>
        <video id="webcam-preview" width="400" autoplay muted style="display: none;"></video>
        <br>
        <label for="videoSource">Camera Source:</label>
        <select id="videoSource"></select>
        <br><br>    
        <button id="startWebcamBtn" class="button">Start Webcam</button>
        <button id="stopWebcamBtn" class="button" disabled>Stop & Analyze</button>
        <div id="webcamSpinner" style="display:none;">
            <div class="spinner"></div>
            <p>Processing live video...</p>
        </div>
        <form id="webcamUploadForm" method="POST" enctype="multipart/form-data" action="/physiological_signal_try" style="display:none;">
            <input type="file" name="file" id="webcamFileInput">
            <button type="submit">Upload and Analyze</button>
        </form>
        <script>
        const videoSelect = document.getElementById('videoSource');

        // Get list of video input devices
        function getCameras() {
            navigator.mediaDevices.enumerateDevices()
            .then(function(devices) {
                videoSelect.innerHTML = ''; // Clear previous
                devices.forEach(function(device) {
                    if (device.kind === 'videoinput') {
                        let option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${videoSelect.length + 1}`;
                        videoSelect.appendChild(option);
                    }
                });
            });
        }
        getCameras();
        navigator.mediaDevices.ondevicechange = getCameras; // Refresh if cams plugged/unplugged

        let mediaRecorder, recordedChunks = [], stream;

        document.getElementById('startWebcamBtn').onclick = async function() {
            const selectedDeviceId = videoSelect.value;
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    deviceId: { exact: selectedDeviceId },
                    frameRate: { ideal: 30, max: 30 }
                }, 
                audio: false
            });

            document.getElementById('webcam-preview').srcObject = stream;
            document.getElementById('webcam-preview').style = "";
            document.getElementById('stopWebcamBtn').disabled = false;
            document.getElementById('startWebcamBtn').disabled = true;

            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.start();
        };

        document.getElementById('stopWebcamBtn').onclick = function() {
            mediaRecorder.stop();
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('webcam-preview').srcObject = null;
            document.getElementById('webcamSpinner').style.display = 'block';
            document.getElementById('stopWebcamBtn').disabled = true;

            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'video/webm' });
                let fileInput = document.getElementById('webcamFileInput');
                let dataTransfer = new DataTransfer();
                let file = new File([blob], 'webcam_recording.webm', { type: 'video/webm' });
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;

                document.getElementById('webcamUploadForm').style.display = 'block';
                document.getElementById('webcamSpinner').style.display = 'none';
            };
        };
        </script>

    </section>
    <footer>
        <div id="footer-placeholder"></div>
    </footer>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>
</html>
