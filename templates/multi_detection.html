<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Detection - DeepVysion+</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/new_styles.css') }}">
</head>
<body>
    <header>
        <div id="navbar-placeholder"></div>
    </header>
    <div class="container">
        <div class="header">    
            <h1 class="title">Try Multi-Detection</h1>
            <p class="subtitle">Analyze videos using multiple detection models, all in one place. <br>(Do take note that it will take a while to run)</p>
        </div>

        <div class="form-card">
            <form id="multiUploadForm" method="POST" action="/multi_detection" enctype="multipart/form-data">
                <div class="methods-section-multi">
                    <h2 class="section-title">Select Detection Methods</h2>
                    <div class="methods-grid-multi">
                        <div class="method-card-multi" data-method="deep_learning">
                            <input type="checkbox" name="methods" value="deep_learning" class="method-checkbox">
                            <div class="method-content">
                                <div class="method-icon-multi">üß†</div>
                                <div class="method-info">
                                    <h3>Deep Learning</h3>
                                    <p>Neural network-based pattern recognition</p>
                                </div>
                            </div>
                        </div>
                        <div class="method-card-multi" data-method="physiological">
                            <input type="checkbox" name="methods" value="physiological" class="method-checkbox">
                            <div class="method-content">
                                <div class="method-icon-multi">üíì</div>
                                <div class="method-info">
                                    <h3>Physiological Analysis</h3>
                                    <p>Uses rPPG to detect abnormal physiological signals</p>
                                </div>
                            </div>
                        </div>
                        <div class="method-card-multi" data-method="body_posture">
                            <input type="checkbox" name="methods" value="body_posture" class="method-checkbox">
                            <div class="method-content">
                                <div class="method-icon-multi">üö∂</div>
                                <div class="method-info">
                                    <h3>Body Posture Analysis</h3>
                                    <p>Posture analysis to identify inconsistent body motion</p>
                                </div>
                            </div>
                        </div>
                        <div class="method-card-multi" data-method="visual_artifacts">
                            <input type="checkbox" name="methods" value="visual_artifacts" class="method-checkbox">
                            <div class="method-content">
                                <div class="method-icon-multi">üëÅÔ∏è</div>
                                <div class="method-info">
                                    <h3>Visual Artifacts</h3>
                                    <p>Detects inconsistent facial features and artifacts</p>
                                </div>
                            </div>
                        </div>
                        <div class="method-card-multi" data-method="audio">
                            <input type="checkbox" name="methods" value="audio" class="method-checkbox">
                            <div class="method-content">
                                <div class="method-icon-multi">üîä</div>
                                <div class="method-info">
                                    <h3>Audio Analysis</h3>
                                    <p>Detects deepfake from audio features</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="upload-section">
                    <h2 class="section-title">Upload Video File</h2>
                    <div id="dropbox" class="dropbox">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-content">
                            <h3>Drop your video here</h3>
                            <p>or click to browse files</p>
                            <span class="file-types">MP4, AVI, MOV, WebM supported</span>
                        </div>
                        <input type="file" name="file" id="file" accept="video/*">
                        <video id="video-preview" controls style="display: none;"></video>
                    </div>
                    <h2 class="section-title" style="margin-top:3rem; margin-bottom: 1rem">Submit Video URL</h2>
                    <div class="dvurl-input-container">
                        <input type="url" name="video_url" id="dvurl-input" class="dvurl-input"
                            placeholder="Paste video URL (e.g. https://...)"
                            pattern="https?://.*"
                            style="width:100%; padding:1rem 1.2rem; border-radius:12px; border:1px solid var(--glass-border); background:var(--card-bg); color:var(--text-primary); font-size:1.1rem;">
                        <span class="dvurl-hint">Supports most social media sites. Visit <a href="/allowed_urls">this page</a> for the full list.</span>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitButton" style="margin-top: 3rem;">Start Analysis</button>
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <div class="processing-text">Processing your video (it may take a few minutes)...</div>
                </div>
            </form>
            <br><hr><br>
            <!-- Webcam Detection Method -->
            <div class="detection-method webcam-method" id="webcamSection">
                <div class="method-header">
                    <div class="method-icon-try">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2v11z" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="method-text">
                        <h2 class="method-title">Live Webcam Detection</h2>
                        <p class="method-description">Use your webcam for real-time detection. Record a short video clip and analyze it instantly.</p>
                    </div>
                </div>
                
                <div class="webcam-controls">
                    <div class="camera-selection">
                        <label for="videoSource">Select Camera:</label>
                        <select id="videoSource"></select>
                    </div>
                    
                    <div class="webcam-preview-container">
                        <video id="webcam-preview" width="600" autoplay muted style="display: none;"></video>
                        <div class="preview-placeholder">
                            <div class="camera-icon">üìπ</div>
                            <p>Camera preview will appear here</p>
                        </div>
                    </div>
                    
                    <div class="webcam-buttons">
                        <button id="startWebcamBtn" class="webcam-button start-btn">
                            <span>Start Recording</span>
                            <div class="record-indicator"></div>
                        </button>
                        <button id="stopWebcamBtn" class="webcam-button stop-btn" disabled>
                            <span>Stop & Analyze</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="red">
                                <rect x="6" y="6" width="12" height="12" stroke="red" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="webcamSpinner" class="webcam-loading">
                        <div class="spinner-container">
                            <div class="spinner"></div>
                        </div>
                        <div class="loading-text">
                            <h4>Processing live video...</h4>
                            <p>Please <b>do not</b> refresh or leave this page!</p>
                        </div>
                    </div>
                </div>
                
                <form id="webcamUploadForm" class="webcam-upload-form" method="POST" enctype="multipart/form-data" action="" style="display:none;">
                    <input type="file" name="file" id="webcamFileInput" style="display: none;">
                    <button type="submit" id="webcamSubmit" class="webcam-button webcam-upload-button">UPLOAD RECORDING</button>
                </form>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    const methodCards = document.querySelectorAll(".method-card-multi");
    const form = document.getElementById("multiUploadForm");
    const spinner = document.getElementById("loadingSpinner");
    const submitButton = document.getElementById("submitButton");
    const fileInput = document.getElementById("file");
    const urlInput = document.getElementById("dvurl-input");
    const webcamSubmit = document.getElementById("webcamSubmit");

    // Method selection UI
    methodCards.forEach(card => {
        card.addEventListener("click", function() {
            const checkbox = this.querySelector(".method-checkbox");
            checkbox.checked = !checkbox.checked;
            this.classList.toggle("selected", checkbox.checked);
        });
    });

    form.addEventListener("submit", function(event) {
        // Validation
        if (!fileInput.value && !urlInput.value) {
            event.preventDefault();
            alert("Please upload a file OR enter a video URL.");
            return false;
        }
        if (fileInput.value && urlInput.value) {
            event.preventDefault();
            alert("Please choose either a file OR a URL, not both.");
            return false;
        }
        const checkedMethods = document.querySelectorAll('.method-checkbox:checked');
        if (checkedMethods.length === 0) {
            event.preventDefault();
            alert("Please select at least one detection method.");
            return false;
        }
        // Show spinner, disable button
        submitButton.disabled = true;
        webcamSubmit.disabled = true;
        submitButton.innerText = "Processing...";
        spinner.style.display = "block";
    });
});

</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const webcamForm = document.getElementById("webcamUploadForm");
    const webcamFileInput = document.getElementById("webcamFileInput");
    const multiForm = document.getElementById("multiUploadForm");
    const multiFileInput = document.getElementById("file");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const submitBtn = document.getElementById("submitButton");
    const urlInput = document.getElementById("dvurl-input");
    const webcamSubmit = document.getElementById("webcamSubmit");

    // Intercept webcamUploadForm's default submission
    webcamForm.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!webcamFileInput.files.length) {
            alert("No recorded video found.");
            return;
        }

        // Inject webcam file into the original multi detection form
        const dt = new DataTransfer();
        dt.items.add(webcamFileInput.files[0]);
        multiFileInput.files = dt.files;

        const checkedMethods = document.querySelectorAll('.method-checkbox:checked');
        if (checkedMethods.length === 0) {
            alert("Please select at least one detection method.");
            return false;
        }
        // Show spinner, disable button
        submitButton.disabled = true;
        webcamSubmit.disabled = true;
        submitBtn.innerText = "Processing...";
        loadingSpinner.style.display = "block";

        multiForm.setAttribute("action", "/multi_detection");
        multiForm.setAttribute("method", "POST");
        multiForm.submit();
    });
});
</script>

    <script src="../static/js/scripts.js"></script>
    <script src="../static/js/handle-upload.js"></script>
    <script src="../static/js/live-webcam.js"></script>
</body>
</html>