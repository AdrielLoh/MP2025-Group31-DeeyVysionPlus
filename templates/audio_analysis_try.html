<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Try Audio Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/new_styles.css') }}">
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let form = document.getElementById("upload-form");
            let spinner = document.getElementById("loadingSpinner");
            let submitButton = document.getElementById("submitButton");

            form.addEventListener("submit", function(event) {
                event.preventDefault();

                // Disable the button and change text
                submitButton.disabled = true;
                submitButton.innerText = "Processing...";

                // Show the spinner
                spinner.style.display = "block";

                // Submit the form normally
                form.setAttribute("action", "/audio_analysis");
                form.setAttribute("method", "POST");
                form.submit();
                return;
            });
        });
    </script>
</head>
<body>
    <header>
        <div id="navbar-placeholder"></div>
    </header>
    <!-- Hero Section -->
    <section class="try-hero">
        <div class="hero-background">
            <div class="animated-pulse"></div>
        </div>
        <div class="hero-content">
            <div class="hero-icon">
                <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                    <circle cx="30" cy="30" r="28" stroke="#667eea" stroke-width="2" fill="url(#audioBg)"/>
                    <polyline points="12,40 18,20 24,33 30,25 36,40 42,18 48,33" fill="none" stroke="#764ba2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="27" y="43" width="6" height="8" rx="2" fill="#4facfe" opacity="0.7"/>
                    <rect x="24" y="32" width="12" height="14" rx="6" fill="#764ba2" opacity="0.8"/>
                    <rect x="50" y="40" width="3" height="8" rx="1.5" fill="#00f2fe" opacity="0.5"/>
                    <rect x="7" y="36" width="3" height="12" rx="1.5" fill="#00f2fe" opacity="0.4"/>
                    <defs>
                        <radialGradient id="audioBg" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#f093fb;stop-opacity:0.08"/>
                            <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.18"/>
                        </radialGradient>
                    </defs>
                </svg>
                <div class="pulse-indicator"></div>
            </div>
            <h1>Try Audio Analysis</h1>
            <p class="hero-description">This physiological signal detection analyzes heart rate patterns and subtle facial color changes using Remote Photoplethysmography.
                 Results may vary based on video quality and lighting conditions, and should not be taken as the complete truth.</p>
        </div>
    </section>
    <section class="try-container">
        <div class="detection-methods">
            <!-- File Upload Method -->
            <div class="detection-method upload-method">
                <div class="method-header">
                    <div class="method-icon-try">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
                            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
                            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
                            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
                            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="method-text">
                        <h2 class="method-title">Upload Audio File</h2>
                        <p class="method-description">Upload an audio file from your device for analysis. Supports most common audio formats, MP4 and MOV.</p>
                    </div>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data" class="upload-form">
                    <div id="dropbox" class="dropbox">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-content">
                            <h3>Drop your audio / video here</h3>
                            <p>or click to browse files</p>
                            <span class="file-types">MP3, WAV, FLAC, OGG, MP4, MOV supported</span>
                        </div>
                        <input type="file" name="file" id="file" accept="audio/*,video/*" required>
                        <video id="audio-preview" controls style="display: none;"></video>
                    </div>
                    <button type="submit" id="submitButton" class="analyze-button">
                        <span>Analyze Audio</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12h14m-7-7l7 7-7 7" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    <div id="loadingSpinner" class="loading-spinner">
                        <div class="spinner-container">
                            <div class="spinner"></div>
                            <div class="processing-waves">
                                <div class="wave wave-1"></div>
                                <div class="wave wave-2"></div>
                                <div class="wave wave-3"></div>
                            </div>
                        </div>
                        <div class="loading-text">
                            <h4>Processing audio...</h4>
                            <p>Analyzing audio features... Please <b>Do not</b> refresh or leave this page!</p>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Live Microphone Recording Method -->
            <div class="detection-method" id="microphoneDetection">
                <div class="method-header">
                    <div class="method-icon-try">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                            <path d="M12 3a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V7a4 4 0 0 1 4-4zm6 10a6 6 0 0 1-12 0m6 6v3m-3 0h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="method-text">
                        <h2 class="method-title">Live Microphone Recording</h2>
                        <p class="method-description">Use your microphone to record real-time audio, and analyze it instantly.</p>
                    </div>
                </div>
                
                <div class="live-audio-controls">
                    <div class="microphone-selection">
                        <label for="audioSource">Select Microphone:</label>
                        <select id="audioSource"></select>
                    </div>
                    
                    <div class="volume-meter-container">
                        <div id="audio-preview-placeholder" class="audio-preview-placeholder">
                            <div class="microphone-icon">üé§</div>
                            <p>Audio levels will appear here</p>
                        </div>
                        <div id="volume-meter" class="volume-meter" style="display: none;">
                            <div class="volume-bars">
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                                <div class="volume-bar"></div>
                            </div>
                        </div>
                        <div class="volume-level-text">
                            <span id="volume-level">Volume: 0%</span>
                            <div id="recording-timer" class="recording-timer" style="display: none;">00:00</div>
                        </div>
                    </div>
                    
                    <div class="audio-buttons">
                        <button id="startAudioBtn" class="audio-button start-btn">
                            <span>Start Recording</span>
                            <div class="record-indicator"></div>
                        </button>
                        <button id="stopAudioBtn" class="audio-button stop-btn" disabled>
                            <span>Stop & Analyze</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="red">
                                <rect x="6" y="6" width="12" height="12" stroke="red" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="audioSpinner" class="audio-loading">
                        <div class="spinner-container">
                            <div class="spinner"></div>
                        </div>
                        <div class="loading-text">
                            <h4>Processing live audio...</h4>
                            <p>Analyzing real-time audio signals... Please <b>Do not</b> refresh or leave this page!</p>
                        </div>
                    </div>
                </div>
                <form id="audioUploadForm" class="audio-upload-form" method="POST" enctype="multipart/form-data" action="/audio_analysis">
                    <input type="file" name="file" id="audioFileInput" style="display: none;">
                    <button type="submit" class="audio-upload-button">ANALYZE RECORDING</button>
                </form>
            </div>
        </div>
    </section>
    <footer>
        <div id="footer-placeholder"></div>
    </footer>

    <script src="../static/js/audio-recording.js"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|BlackBerry|webOS/i.test(navigator.userAgent);
        }

        if (isMobileDevice()) {
            document.getElementById("microphoneDetection").style.display="none";
            document.getElementById("audioUploadForm").style.display="none";
        }
        // Drag and drop for audio upload
    const dropbox = document.getElementById('dropbox');
    const fileInput = document.getElementById('file');
    const audioPreview = document.getElementById('audio-preview');
    const uploadForm = document.getElementById('upload-form');

    if (dropbox && fileInput && audioPreview && uploadForm) {
        // dropbox.addEventListener('click', () => fileInput.click());

        dropbox.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropbox.classList.add('dragover');
        });

        dropbox.addEventListener('dragleave', () => dropbox.classList.remove('dragover'));

        dropbox.addEventListener('drop', (e) => {
            e.preventDefault();
            dropbox.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            handleFile(file);
        });

        function handleFile(file) {
            if (file) {
                const url = URL.createObjectURL(file);
                audioPreview.src = url;
                audioPreview.style.display = 'block';
                dropbox.querySelector('p').style.display = 'none';
            } else {
                audioPreview.style.display = 'none';
                dropbox.querySelector('p').style.display = 'block';
            }
        }

        uploadForm.addEventListener('submit', function(e) {
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Please select an audio file before submitting.');
                fileInput.focus();
            }
        });
    }  
    </script>
</body>
</html>